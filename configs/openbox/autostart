#!/bin/bash
# Hide cursor after 1 second of inactivity
unclutter -idle 1 &

# Disable screen blanking
xset s off
xset -dpms
xset s noblank

# Load display configuration
DISPLAY_CONFIG="/etc/kioskbook/display.conf"
if [ -f "$DISPLAY_CONFIG" ]; then
    . "$DISPLAY_CONFIG"
else
    # Fallback to default
    DISPLAY_URL="https://kioskbook.ca/display"
    DISPLAY_TOKEN="YOUR_TOKEN_HERE"
fi

# Build full URL with token
KIOSK_URL="${DISPLAY_URL}?token=${DISPLAY_TOKEN}"

# Build loading page URL with parameters
LOADING_URL="file:///var/www/html/kioskbook-loading.html?url=${DISPLAY_URL}&token=${DISPLAY_TOKEN}"

# Set VA-API driver for hardware video acceleration
export LIBVA_DRIVER_NAME=radeonsi
export LIBVA_MESSAGING_LEVEL=2

# Start Chromium in kiosk mode with font optimization and hardware acceleration
exec chromium \
    --kiosk \
    --no-sandbox \
    --disable-infobars \
    --disable-features=TranslateUI,UseChromeOSDirectVideoDecoder \
    --enable-features=VaapiVideoDecoder,VaapiVideoEncoder,VaapiVideoDecodeLinuxGL \
    --disable-ipc-flooding-protection \
    --no-first-run \
    --fast \
    --fast-start \
    --disable-default-apps \
    --disable-popup-blocking \
    --disable-prompt-on-repost \
    --no-message-box \
    --start-fullscreen \
    --force-device-scale-factor=1 \
    --font-render-hinting=none \
    --disable-session-crashed-bubble \
    --disable-restore-session-state \
    --enable-gpu-rasterization \
    --ignore-gpu-blocklist \
    --disable-gpu-driver-bug-workarounds \
    --enable-logging=stderr \
    --vmodule=*/media/*=3 \
    "$LOADING_URL"
