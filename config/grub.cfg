#
# KioskBook GRUB Configuration
#
# Optimized for ultra-fast boot times (<5 seconds) with silent boot
# and AMD GPU-specific optimizations for kiosk operation.
#
# This configuration is automatically generated during installation.
# Manual modifications will be overwritten during updates.
#

# Boot timeout - 0 for instant boot
set timeout=0
set timeout_style=hidden

# Default boot entry
set default=0

# Console and terminal settings for silent boot
terminal_input console
terminal_output console

# Disable unnecessary modules to speed up boot
insmod part_gpt
insmod ext2
insmod linux
insmod gzio
insmod gettext

# Load video modules for early graphics
insmod all_video
insmod gfxterm
insmod font

# Set graphics mode early
if loadfont /boot/grub/fonts/unicode.pf2 ; then
  set gfxmode=auto
  insmod gfxterm
  set gfxpayload=keep
  terminal_output gfxterm
fi

# Enable graphics mode for Plymouth
set gfxmode=auto
set gfxpayload=keep

# Main boot entry for KioskBook
menuentry 'KioskBook Kiosk System' --class kioskbook --class gnu-linux --class gnu --class os {
    recordfail
    load_video
    gfxmode $linux_gfx_mode
    insmod gzio
    insmod part_gpt
    insmod ext2
    
    # Set root partition (will be updated during installation)
    set root='hd0,gpt2'
    
    # Load kernel with optimized parameters for silent boot
    linux /boot/vmlinuz root=UUID=ROOT_UUID ro \
        quiet splash loglevel=0 \
        rd.systemd.show_status=false \
        rd.udev.log_priority=0 \
        systemd.show_status=false \
        plymouth.enable=1 \
        vt.global_cursor_default=0 \
        console=tty12 \
        mitigations=off \
        clocksource=tsc \
        tsc=reliable \
        no_timer_check \
        noreplace-smp \
        elevator=mq-deadline \
        fsck.mode=skip \
        amd_pstate=active \
        amdgpu.dc=1 \
        amdgpu.dpm=1 \
        amdgpu.gpu_recovery=1 \
        amdgpu.runpm=1 \
        amdgpu.bapm=1 \
        amdgpu.si_support=1 \
        amdgpu.cik_support=1 \
        radeon.si_support=0 \
        radeon.cik_support=0 \
        processor.max_cstate=1 \
        intel_idle.max_cstate=1 \
        acpi_osi=Linux \
        rcu_nocbs=0-7 \
        usbcore.autosuspend=-1 \
        audit=0 \
        selinux=0 \
        enforcing=0 \
        transparent_hugepage=madvise \
        vm.swappiness=10 \
        systemd.mask=systemd-gpt-auto-generator \
        systemd.mask=systemd-cryptsetup-generator \
        init=/sbin/init
    
    # Load initramfs
    initrd /boot/initrd
}

# Advanced boot entry for recovery/debugging
menuentry 'KioskBook Recovery Mode' --class recovery --class gnu-linux --class gnu --class os {
    recordfail
    load_video
    insmod gzio
    insmod part_gpt
    insmod ext2
    
    set root='hd0,gpt2'
    
    # Recovery mode with verbose output
    linux /boot/vmlinuz root=UUID=ROOT_UUID ro \
        single \
        systemd.unit=multi-user.target \
        plymouth.enable=0 \
        amdgpu.dc=1 \
        init=/sbin/init
    
    initrd /boot/initrd
}

# Memory test entry
menuentry 'Memory Test (memtest86+)' {
    insmod part_gpt
    insmod ext2
    set root='hd0,gpt1'
    linux16 /boot/memtest86+.bin
}

# Firmware setup entry (if available)
if [ "${grub_platform}" = "efi" ]; then
menuentry 'UEFI Firmware Settings' --id 'uefi-firmware' {
    fwsetup
}
fi